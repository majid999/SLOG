function [ w ] = StructuredLatentSpace_BeamSearch(i, xi, A , X,k, p, B )
%UNTITLED Summary of this function goes here
%   Detailed explanation goes here



%%%%%%%%%%%%%%%%% Greedy : BeamSearch


w = zeros(B,size(X,1));

gain = zeros(size(w));
pref = zeros(B,1);

thisRoundVal = 0;

thisRoundGain = w;
thisRound =w;

for kk=1:k,
    
    
    index = 1;
    if kk>1
        it = B;
    else
        it = 1;
    end
    for b=1:it,
       zeroElements = find(~w(b,:));
       wb = w(b,:);
       g= gain(b,:);
       pf = pref(b);
       for ii=1:length(zeroElements),
           el = zeroElements(ii);

           thisRound(index, :) = wb;
           thisRound(index, el)=1;
           
           [f ]=NoneLinearLatentSpaceEval( thisRound(index,:), A, xi, p);
           thisRoundVal(index) = f;
           
           thisRoundGain(index,:) = g;
           thisRoundGain(index, el) = f-pf;
           

           
           index = index +1;
           
       end
       
       
        
    end
   
    
   for b =1:B,
          
        [val ind] = max(thisRoundVal);
        
        w(b,:) = thisRound(ind,:);
        gain(b,:) = thisRoundGain(ind,:);
        thisRoundVal(ind)= min(thisRoundVal);
        pref(b) = val;
           
   end
   
    thisRoundVal = 0;
    thisRound = zeros(size(w));
    thisRoundGain = zeros(size(w));
       

end


maxval = 0;
maxw = 0;
maxgain=0;
for bb=1:B,
    val = NoneLinearLatentSpaceEval( w(bb,:),A, xi, p);
    if val > maxval,
        maxval = val;
        maxw = w(bb,:);
        maxgain = gain(bb,:);
    end
end

fprintf('\n BeamSearch p: %e \n', p);










end


function [f] = NoneLinearLatentSpaceEval(w , A, xi, p)
    
    f =    sum(sum(repmat(w',1 , size(A,2)).*A .* repmat(xi, size(A,1),1)).^p);

end

function [f df] = NoneLinearLatentSpace(w, wtopics, xP, p , lambda)

base = 0.001;
f1 =  sum(sum(repmat(w',1 , size(wtopics,2)).*wtopics .* repmat(xP, size(wtopics,1),1)+base).^p);
f2 = norm(lambda .*w, 1);
f1
f2
f = -f1 +  f2;

df1 = p*(sum(repmat(w',1 , size(wtopics,2)).*wtopics .* repmat(xP, size(wtopics,1),1)+ base).^(p-1));
df2 = sum(wtopics .* repmat(xP, size(wtopics,1),1));
df3 = sum(df1 .* df2);
df4 = (abs(w)./w);
df4(w==0) = 0;

df = - df3+ lambda .* df4;



end


function [f] = NoneLinearLatentSpaceEvalMixed(w , wtopics, xP, p,q, a)

    f =sum(nthroot(sum(repmat(w',1 , size(wtopics,2)).*wtopics .* repmat(xP, size(wtopics,1),1)-a).^q, p));

end

function [f df] = NoneLinearLatentSpaceMixed(w, wtopics, xP, p ,q, lambda, a)
f1 = sum(nthroot(sum(repmat(w',1 , size(wtopics,2)).*wtopics .* repmat(xP, size(wtopics,1),1)-a).^q, p));
f2 = norm(lambda .*w, 1);


f = -f1+  f2;

df1 = (q/p)*(nthroot((sum(repmat(w',1 , size(wtopics,2)).*wtopics .* repmat(xP, size(wtopics,1),1) - a).^(q-p)), p));
df2 = sum(wtopics .* repmat(xP, size(wtopics,1),1));
df3 = sum(df1.*df2);
df4 = (abs(w)./w);
df4(w==0) = 0;

df = -df3 + lambda .* df4;



end

